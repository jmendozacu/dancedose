<!DOCTYPE html>
<html>

<head>
   <title>Google Calendar API Quickstart</title>
   <meta charset='utf-8' />
   <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUWxLyE7XIZBWbUiwziKI6_fx65pl7wLk&libraries=places,geometry"></script>
   <script src="jdrupal.js">
   </script>
</head>

<body>
   <p>Google Calendar API Quickstart</p>

   <!--Add buttons to initiate auth sequence and sign out-->
   <button id="authorize-button" style="display: none;">Authorize</button>
   <br>
   <button id="signout-button" style="display: none;">Sign Out of Calendar</button>
<br>
 <p><input id="name"  type="text" /></p>
<p> <input id="pass" type="password" /> </p>
<br>
   <button id="signin-button" style="display: none;">Sign In to Swing dose</button>
<br>
   <button id="startimport-button" style="display: none;">Start Import Google Calendar</button>
   <br>
   <button id="startswingplanit-button" style="display: none;">Start Import SwingPlanIt</button>
   <br>
   <button id="startTeamUpButton-button" style="display: none;">Start Import TeamUp</button>
<br>
   <button id="deleteall-button" style="display: none;">Delete all nodes</button>
   <br>
   <button id="deleteidentical-button" style="display: none;">Delete identical nodes</button>
<br>
   <button id="stop-button" style="display: none;">Stop</button>
<br>


   <pre id="content"></pre>

   <script type="text/javascript">
   // 98b62d4cfddfdc08a0509b0ccc6b08371cc1c1d135c3681b8b5a39d6fb0f1a6d
   var TEAMUP_API_KEY = '98b62d4cfddfdc08a0509b0ccc6b08371cc1c1d135c3681b8b5a39d6fb0f1a6d';
   // Client ID and API key from the Developer Console
   var CLIENT_ID = '274492602001-p7v19adot9um1f1em6r8ifpnrc4tp0fl.apps.googleusercontent.com';
   var API_KEY = 'AIzaSyCUWxLyE7XIZBWbUiwziKI6_fx65pl7wLk'; //'AIzaSyBteUZBLACzKQi0Y-wu7bW3noU5rPi5pd4';
   //AIzaSyCUWxLyE7XIZBWbUiwziKI6_fx65pl7wLk
   // Array of API discovery doc URLs for APIs used by the quickstart
   var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

   // Authorization scopes required by the API; multiple scopes can be
   // included, separated by spaces.
   var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

   var authorizeButton = document.getElementById('authorize-button');
   var signoutButton = document.getElementById('signout-button');
   var startimportButton = document.getElementById('startimport-button');
   var stopButton = document.getElementById('stop-button');
   var deleteallButton = document.getElementById('deleteall-button');
   var deleteIdenticalButton = document.getElementById('deleteidentical-button');
   var signinButton = document.getElementById('signin-button');
   var startTeamUpButton = document.getElementById('startTeamUpButton-button');
   
   var startswingplanitButton = document.getElementById('startswingplanit-button');
   /**
    *  On load, called to load the auth2 library and API client library.
    */
   function handleClientLoad() {
      gapi.load('client:auth2', initClient);
   }

   /**
    *  Initializes the API client library and sets up sign-in state
    *  listeners.
    */
   function initClient() {
      gapi.client.init({
         apiKey: API_KEY,
         clientId: CLIENT_ID,
         discoveryDocs: DISCOVERY_DOCS,
         scope: SCOPES
      }).then(function() {
         // Listen for sign-in state changes.
         gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

         // Handle the initial sign-in state.
         updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
         authorizeButton.onclick = handleAuthClick;
         signoutButton.onclick = handleSignoutClick;
      });
   }
   jDrupal.settings = {
      sitePath: 'https://swing.dancedose.com', // The path to your Drupal site, for example: http://www.example.com
      basePath: '/'
   };
   var dance_styles = {
      "lindy": 1,
      "blues": 2,
      "balboa": 3,
      "tap": 4,
      "jazzroots": 5,
      "shag": 6,
      "electroswing": 7,
      "charleston": 8,
      "boogie": 9
   }
   var dance_types = {
      "parties": 12000,
      "festivals": 13000,
      "workshops": 14000,
      "practices": 15000,
      "canceled": 10000,
      "openair": 11000,
   }
  

   
   var calendars = [
       
      {
         calId: '6lq1ruijo5o8t3joitnbb5hgbtupt4kh@import.calendar.google.com',
         author: "moderator",
         name: "Sergei's FB",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      },    

       {
         calId: '9vssfs721mjcnisal8gfjnsq30@group.calendar.google.com',
         author: "caencaswing",
         name: "Caen Ça Swing Associaiton caennaise (Caen)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,        
       {
         calId: 'caencaswing@gmail.com',
         author: "caencaswing",
         name: "Caen Ça Swing (Caen)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,         
       {
         calId: 'assogardenswing@gmail.com',
         author: "GardenSwing",
         name: "GardenSwing (Rouen)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,           
       {
         calId: '2g4le10f6adtqpv8cpuopdbqag@group.calendar.google.com',
         author: "moderator",
         name: "stages en france",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,        
       {
         calId: 'grenobleswing@gmail.com',
         author: "grenobleswing",
         name: "Region de Grenoble, Isère et Rhône-Alpes",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,        
       {
         calId: 'uaq9ava14sh5sm55kn3kjmvlo0@group.calendar.google.com',
         author: "YoupiSwing",
         name: "YS - Evénements Pur Swing Nationaux (Nantes)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,        
       {
         calId: '5n7m0engu5efu9cjcm7h83b6sc@group.calendar.google.com',
         author: "YoupiSwing",
         name: "YoupiSwing - Evénements mixtes (Nantes)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,       
       {
         calId: '5n7m0engu5efu9cjcm7h83b6sc@group.calendar.google.com',
         author: "Swingchap",
         name: "Swingchap' (Orléans)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,      
      {
         calId: '6a0ug4in571vklnaagv9htp820@group.calendar.google.com',
         author: "lindyspot",
         name: "Lindy Spot Public (strasbourg)",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      } ,      
     {
         calId: '7qjrf8hhnfstohtrkq2cs2ursg@group.calendar.google.com',
         author: "SwinginBerlin",
         name: "SwinginBerlin.de",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      }, 
      {
         calId: 'v1mmtakk87qag5btpudji4334o@group.calendar.google.com',
         author: "Antwerp",
         name: "Antwerp",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      },       
      {
         calId: 'lo7nlqnlkq0lok5aesf7vn40a0@group.calendar.google.com',
         author: "swingitbrussels",
         name: "Surrounding Cities Brussels",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      },        
      {
         calId: 'swingitbrussels@gmail.com',
         author: "swingitbrussels",
         name: "swingitbrussels@gmail.com",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["parties"],
         price: "cf info"
      },       
    

      {
         calId: 'sbmfdgjj9ougua78rbgpt14o6k@group.calendar.google.com',
         author: "joyss_jc",
         name: "Joyss JC - Stages",
         styles: [dance_styles["lindy"], dance_styles["jazzroots"]],
         type: dance_types["workshops"],
         price: "cf info"
      },       
      {
         calId: 'dgasagbo18qlblnni1a3ouv82o@group.calendar.google.com',
         author: "hopnswing",
         name: "HnS Cours",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },      
      {
         calId: 'hop.n.swing@gmail.com',
         author: "hopnswing",
         name: "HnS",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: '5eu28c0d4i01feb7l1hklajjtg@group.calendar.google.com',
         author: "hopnswing",
         name: "HnS ext",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["openair"],
         price: "free"
      },
      {
         calId: 'v98lpqqrufiqd6njhr47jrevkg@group.calendar.google.com',
         author: "SwingCorner",
         name: "SwingCorner (stages)",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: '33e7tu1a0fbdimqmrimlcbii40@group.calendar.google.com',
         author: "swingybluesenbuenosaires",
         name: "Swing y Blues en Buenos Aires",
         styles: [dance_styles["lindy"], dance_styles["charleston"], dance_styles["blues"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'ociv6cnt1vq5m6ahf9gjpinvro@group.calendar.google.com',
         author: "brotherswing",
         name: "Brotherswing - soirées import",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'u66cpup388i7m6cpo2ecgdhf68@group.calendar.google.com',
         author: "brotherswing",
         name: "Brotherswing - stages/pratiques import",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 's20omdieengvhkh9k2fgjdqoh0@group.calendar.google.com',
         author: "dancingoutsideparis",
         name: "Dancing outside",
         styles: [dance_styles["lindy"], dance_styles["balboa"], dance_styles["electroswing"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "gratuit"
      },
      {
         calId: 'vg6301s4rtr59e5tm879uijl30@group.calendar.google.com',
         author: "templeduswing",
         name: "Ecole Temple du Swing, Lindy Hop - stages/pratiques",
         styles: [dance_styles["lindy"], dance_styles["balboa"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'jv4b53vkfepv11kfsfq13lu9i8@group.calendar.google.com',
         author: "eksaswing",
         name: "Eksa Swing bals",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'qd69r8p5332ql8srh8ol20ef9s@group.calendar.google.com',
         author: "eksaswing",
         name: "Eksa Swing pratiques/stages",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'c2636uhtkfr19n7eum0lvmrd5k@group.calendar.google.com',
         author: "gregswing",
         name: "Greg'Swing St Grégoire",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'fousduswing.cal@gmail.com',
         author: "fousduswing",
         name: "Fous Du Swing - soiréess",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'enbj8ba4feaesd9ed254srjhrk@group.calendar.google.com',
         author: "jazzyfeet",
         name: "Jazzy feet - soirées",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: '5r26kah85geld5ndar74rlaimg@group.calendar.google.com',
         author: "jazzyfeet",
         name: "Jazzy feet - stages",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'oc06qshleao6np5jflqqgjfvdk@group.calendar.google.com',
         author: "chatonsswingueurs",
         name: "LesSoiréesLindyHopLesChatonsSwingueurs",
         styles: [dance_styles["lindy"], dance_styles["charleston"], dance_styles["balboa"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'v2h0p76cmvon1f94f6tvthva4k@group.calendar.google.com',
         author: "chatonsswingueurs",
         name: "LesStagesLindyHopLesChatonsSwingueurs",
         styles: [dance_styles["lindy"], dance_styles["charleston"], dance_styles["balboa"], dance_styles["blues"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'misselectroswing@gmail.com',
         author: "lillyvanderbilt",
         name: "Lilly Vanderbilt",
         styles: [dance_styles["electroswing"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'c2rplia3s3tqo4o5bkb4qvv5ck@group.calendar.google.com',
         author: "lindyhopparis",
         name: "Lindy Hop Paris - À 1-2h de Paris",
         styles: [dance_styles["lindy"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'agvoe9kqk84va0v0gjrsd5rtrc@group.calendar.google.com',
         author: "lindyhopparis",
         name: "Lindy Hop Paris - Ailleurs en France",
         styles: [dance_styles["lindy"]],
         type: dance_types["festivals"],
         price: "cf info"
      },
      {
         calId: '5ci8ea4nul6eiimfa37tiifpcg@group.calendar.google.com',
         author: "lindyhopparis",
         name: "Lindy Hop Paris - Soirées",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'ntr58hodv5vcmncc62qccfe4ng@group.calendar.google.com',
         author: "lindyhopparis",
         name: "Lindy Hop Paris - Stages",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'f8ednebjm8u9nikne38ctkmr3o@group.calendar.google.com',
         author: "meduseceleste",
         name: "Méduse Céleste - stages/pratiques",
         styles: [dance_styles["lindy"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: '2q3nbdjai5uufda1dfjt6rj05o@group.calendar.google.com',
         author: "parisswingcity",
         name: "Paris Swing City - soirées",
         styles: [dance_styles["lindy"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'likqe7mngnf1t2em1c4bedm8g8@group.calendar.google.com',
         author: "parisswingcity",
         name: "Paris Swing City - soirées",
         styles: [dance_styles["lindy"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'likqe7mngnf1t2em1c4bedm8g8@group.calendar.google.com',
         author: "parisswingcity",
         name: "Paris Swing City - soirées",
         styles: [dance_styles["lindy"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: '7cqclq8acds1p9lirvovfug4lc@group.calendar.google.com',
         author: "shakethatswing",
         name: "Shake That Swing - Soirées",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'o1oicgvr7t31it1ggf461d7vt8@group.calendar.google.com',
         author: "shakethatswing",
         name: "Shake That Swing - Stages/Pratiques",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'e00e2n5tjvhu32iumsj2eij9eo@group.calendar.google.com',
         author: "socialswingsystem",
         name: "Social Swing Systeme - soirées",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["parties"],
         price: "cf info"
      },
      {
         calId: 'e00e2n5tjvhu32iumsj2eij9eo@group.calendar.google.com',
         author: "socialswingsystem",
         name: "Social Swing Systeme - stages/pratiques",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: '1pfdl8qhlh7pc26mfdsts86fh8@group.calendar.google.com',
         author: "parisswing",
         name: "Soirées Paris-Swing",
         styles: [dance_styles["lindy"], dance_styles["balboa"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'spiritoflindy.asso@gmail.com',
         author: "spiritoflindy",
         name: "SoL SpiritofLindy",
         styles: [dance_styles["lindy"], dance_styles["balboa"], dance_styles["charleston"], dance_styles["shag"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'ks36ug1evgdsiovknm15n7hltk@group.calendar.google.com',
         author: "swingconnection",
         name: "Swing Connection, Lindy - stages/pratiques",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'i4unap9tq8jrj7c1i1lgg32c6s@group.calendar.google.com',
         author: "swingdelight",
         name: "Swing Delight - stages/pratiques",
         styles: [dance_styles["lindy"], dance_styles["charleston"], dance_styles["jazzroots"]],
         type: dance_types["workshops"],
         price: "cf info"
      },
      {
         calId: 'eunk7hoc6k6kr5gk1d8vmkf6fg@group.calendar.google.com',
         author: "swingisthething",
         name: "Swing is the thing - stages",
         styles: [dance_styles["lindy"], dance_styles["charleston"]],
         type: dance_types["workshops"],
         price: "cf info"
      }
     
   ];
   var global_it = 1;
   var cal_it = 0;
   var views_results = [];
   var users =[];
   
    var google_events = [];
    var event_it = 0;
    var prev_address = null;

   /**
    *  Called when the signed in status changes, to update the UI
    *  appropriately. After a sign-in, the API is called.
    */
   var locked = false;
   var devquit = false;
   var timerId = null;
   var delay = 10;
   var delay_init =  10;
   var swingplanit_data = [];

   var teamup_calendars = [
       { 
         author:"toulouseswingnblues",
         id:   'ksxbw7fp28sigfndvd',
         styles: [],
         data: []
       },
        { 
         author:"labelblues",
         id:   '1xbw7fp28sigfndvd',
         styles: [],
         data: []
       }
       ];
                                     
   var sourceID="";

   function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
         authorizeButton.style.display = 'none';
         signoutButton.style.display = 'block';



         (function($) {
            $.connect().then(function(result) {

               var account = $.currentUser();
               console.log("User: " + account.id());

               startimportButton.style.display = 'block';
               stopButton.style.display = 'block';
               deleteallButton.style.display = 'block';
                startswingplanitButton.style.display = 'block';
                deleteIdenticalButton.style.display = 'block';
                
                startTeamUpButton.style.display = 'block';
                
               startimportButton.disabled = true;
               stopButton.disabled = true;
               deleteallButton.disabled = true;
               deleteIdenticalButton.disabled = true;
               startswingplanitButton.disabled = true;
               
               startTeamUpButton.disabled = true;

               if (account.isAuthenticated()) {
                   
                    $.userLogout().then(function() {
                         signinButton.style.display = 'block';
                      console.log('Logged out!');
                    });
                 
               } else {
                  signinButton.style.display = 'block';

               }

               signinButton.onclick = function() {
                  var username = document.getElementById('name').value;
                  var password = document.getElementById('pass').value;
                  $.userLogin(username, password).then(function() {
                       $.viewsLoad('/users_rest/' + '' + '?_format=json').then(function(view) {

                         users = view.getResults();
                         appendPre(users.length + " users received! ");
                          signinButton.style.display = 'none';
                          startimportButton.disabled = false;
                          stopButton.disabled = true;
                         deleteallButton.disabled = false;
                         deleteIdenticalButton.disabled = false;
                          startswingplanitButton.disabled = false;
                           startTeamUpButton.disabled = false;
                       });

                  }, function(err) {
                     console.log("user login error: " + JSON.stringify(err));
                  });
               }
               
                startTeamUpButton.onclick = function() {
                    devquit = false;
                     // Send a GET request for all events in a date range
                      startTeamUpButton.disabled = true;
                      startswingplanitButton.disabled = true;
                     startimportButton.disabled = true;
                     stopButton.disabled = false;
                     deleteallButton.disabled = true;
                     deleteIdenticalButton.disabled = true;
                     sourceID="teamup"; 
                     importTeamUp();
                }
            
                startswingplanitButton.onclick = function() {
                  startswingplanitButton.disabled = true;
                  startimportButton.disabled = true;
                  stopButton.disabled = false;
                  deleteallButton.disabled = true;
                  deleteIdenticalButton.disabled = true;
                  startTeamUpButton.disabled = true;
                     function readTextFile(file, callback) {
                        var rawFile = new XMLHttpRequest();
                        rawFile.overrideMimeType("application/json");
                        rawFile.open("GET", file, true);
                        rawFile.onreadystatechange = function() {
                            if (rawFile.readyState === 4 && rawFile.status == "200") {
                                callback(rawFile.responseText);
                            }
                        }
                        rawFile.send(null);
                     }
                     sourceID="swingplanit"; 
                       global_it = 1;
                       //usage:
                       readTextFile("results_tv5vYwqk6EwjnZm5E.json", function(text){
                           swingplanit_data = JSON.parse(text);
                          //console.log(swingplanit_data);
                          event_it = 0;
                          
                          prev_address = null;

                           $.viewsLoad('/swing_events_import/' + '' + '?_format=json').then(function(view) {

                              views_results = view.getResults();
                              appendPre(views_results.length + " views received! ");
                              treat_event();

                           });
                          
                        
                        
                       });
                }

               startimportButton.onclick = function() {
                  devquit = false;
                  appendPre("getting views...");
                  startimportButton.disabled = true;
                  stopButton.disabled = false;
                  deleteallButton.disabled = true;
                  deleteIdenticalButton.disabled = true;
                  startswingplanitButton.disabled = true;
                  startTeamUpButton.disabled = true;
                  global_it = 1;
                  sourceID="googleCalendar"; 
                  prev_address = null;

                  $.viewsLoad('/swing_events_import/' + '' + '?_format=json').then(function(view) {

                     views_results = view.getResults();
                     appendPre(views_results.length + " views received! ");
                     listUpcomingEvents();

                  });

               }
               
               stopButton.onclick = function() {

                  startimportButton.disabled = false;
                  stopButton.disabled = true;
                  deleteallButton.disabled = false;
                  deleteIdenticalButton.disabled = false;
                  startswingplanitButton.disabled = false;
                  startTeamUpButton.disabled = false;
                  devquit = true;
                  locked = false;
                  global_it = 1;
                  cal_it = 0;
                  views_results = [];
                  appendPre("Aborted..");
               }
               
               deleteIdenticalButton.onclick = function() {
                  devquit = false;
                  event_it = 0;
                  appendPre("getting views...");
                  startimportButton.disabled = true;
                  startswingplanitButton.disabled = true;
                  stopButton.disabled = false;
                  deleteallButton.disabled = true;
                  deleteIdenticalButton.disabled = true;
                  startTeamUpButton.disabled = true;
                  $.viewsLoad('/swing_events_import/' + '' + '?_format=json').then(function(view) {

                     views_results = view.getResults();
                     appendPre(views_results.length + " views received! ");

                     deleteIdentical();

                  });
                }
                
               deleteallButton.onclick = function() {
                  devquit = false;
                  event_it = 0;
                  appendPre("getting views...");
                  startimportButton.disabled = true;
                  startswingplanitButton.disabled = true;
                  stopButton.disabled = false;
                  deleteallButton.disabled = true;
                  deleteIdenticalButton.disabled = true;
                  startTeamUpButton.disabled = true;
                  $.viewsLoad('/swing_events_import/' + '' + '?_format=json').then(function(view) {

                     views_results = view.getResults();
                     appendPre(views_results.length + " views received! ");

                     deleteAll();

                  });
               }
               
               
                 function deleteIdentical() {
                     // console.log('Node  #'  +views_results[i].nid + ':  ' + views_results[i].title);
                     // console.log('currentNode.title  '  + event.summary);
                     if(event_it == views_results.length-1) 
                     {
                         appendPre( 'Clean up finished! ' );
                         return;
                     }

                     if (views_results[event_it] != undefined) locked = true;
                     else {
                        locked = false;
                       
                        event_it++;
                        deleteIdentical();
                        return;
                     }
                     var delete_flag = false;
                    
                     for( var id_del = event_it +1;   id_del < views_results.length; id_del++ )
                     {
                         if(views_results[event_it].title == views_results[id_del].title &&
                            views_results[event_it].field_event_date_range == views_results[id_del].field_event_date_range && 
                            views_results[event_it].nid != views_results[id_del].nid  )
                            {
                                delete_flag = true;
                                break;
                            }
                     }
                     
                     if(delete_flag)
                     {
                         appendPre( 'id_del : ' + id_del + 'event_it : ' + event_it);
                         appendPre( 'Date range : ' + views_results[event_it].field_event_date_range);
                         appendPre( 'Title : ' + views_results[event_it].title);
                         appendPre(event_it + ') Node #' + views_results[event_it].nid + 'should be deleted!');
            
                                 $.nodeLoad(views_results[event_it].nid).then(function(node) {

                                    console.log(event_it + ') Node #' + views_results[event_it].nid + ' loaded!');
            
                                    node.delete().then(function() {
                                          locked = false;
                                          appendPre(event_it + ') Node #' + views_results[event_it].nid + ' deleted!');
                                       }),
                                       function(err) {
                                          console.log("node delete error: " + JSON.stringify(err));
                                          locked = false;
                                       };
                                    // then delete it.
            
            
                                 }, function(err) {
                                    console.log("node load error: " + JSON.stringify(err));
                                    locked = false;
                                 });
                         }
                         else 
                         {
                              event_it++;
                              deleteIdentical();
                              return
                         }

                     delay = 10;
                     timerId = setTimeout(function deleteTimer() {
                        if (devquit) return;
                        if (locked === true) {
                           timerId = setTimeout(deleteTimer, delay);
                        } else {
                           if (event_it < views_results.length) {
                              event_it++;
                              deleteIdentical();
                              return;
                           } else {
                              startimportButton.disabled = false;
                              stopButton.disabled = true;
                              deleteallButton.disabled = false;
                              deleteIdenticalButton.disabled = false;
                              return;
                           }
                        }


                     }, delay);

                  }
                  
                  function deleteAll() {
                     // console.log('Node  #'  +views_results[i].nid + ':  ' + views_results[i].title);
                     // console.log('currentNode.title  '  + event.summary);

                     if (views_results[event_it] != undefined) locked = true;
                     else {
                        locked = false;
                        event_it++;
                        deleteAll();
                        return;
                     }

                     $.nodeLoad(views_results[event_it].nid).then(function(node) {


                        console.log(event_it + ') Node #' + views_results[event_it].nid + ' loaded!');

                        node.delete().then(function() {
                              locked = false;
                              appendPre(event_it + ') Node #' + views_results[event_it].nid + ' deleted!');
                           }),
                           function(err) {
                              console.log("node delete error: " + JSON.stringify(err));
                              locked = false;
                           };
                        // then delete it.


                     }, function(err) {
                        console.log("node load error: " + JSON.stringify(err));
                        locked = false;
                     });


                     delay = 10;
                     timerId = setTimeout(function deleteTimer() {
                        if (devquit) return;
                        if (locked === true) {
                           timerId = setTimeout(deleteTimer, delay);
                        } else {
                           if (event_it < views_results.length) {
                              event_it++;
                              deleteAll();
                              return;
                           } else {
                              startimportButton.disabled = false;
                              stopButton.disabled = true;
                              deleteallButton.disabled = false;
                              return;
                           }
                        }


                     }, delay);


                  }

                });


         }(jDrupal));

            
         } else {
         authorizeButton.style.display = 'block';
         signoutButton.style.display = 'none';
        }
   }
   
     function importTeamUp() {
        appendPre("getting views...");
        
         global_it = 1;
         event_it = 0;

          jDrupal.viewsLoad('/swing_events_import/' + '' + '?_format=json').then(function(view) {

            views_results = view.getResults();
             appendPre(views_results.length + " views received! ");
                makeCorsRequest(
                    'https://api.teamup.com/'+teamup_calendars[cal_it].id+'/events?startDate=2018-03-01&endDate=2018-09-01',
                      function(xhr) {
                         var data = JSON.parse(xhr.responseText);
                          teamup_calendars[cal_it].data = data.events;
                          treat_event();

                     },
                     function(xhr) {
                         var data = JSON.parse(xhr.responseText);
                          console.log('Request failed with code '+ xhr.status +': ' + JSON.stringify(data));
                         
                     }
                 );  

            
             

          });
               
    }
   /**
    *  Sign in the user upon button click.
    */
   function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
   }

   /**
    *  Sign out the user upon button click.
    */
   function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
   }

   /**
    * Append a pre element to the body containing the given message
    * as its text node. Used to display the results of the API call.
    *
    * @param {string} message Text to be placed in pre element.
    */
   function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      

      pre.insertBefore(textContent, pre.childNodes[0]);
      //pre.appendChild(textContent);
   }



   var geocoder = new google.maps.Geocoder();

   /**
    * Print the summary and start datetime/date of the next ten events in
    * the authorized user's calendar. If no events are found an
    * appropriate message is printed.
    */

  // API https://developers.google.com/calendar/v3/reference/events
  
 //  https://apidocs.teamup.com/#teamup-api-overview
   function listUpcomingEvents() {
      gapi.client.calendar.events.list({
         'calendarId': calendars[cal_it].calId,
        // 'timeMin': (new Date()).toISOString(),
      //   'updated': (new Date("2018 March 19")).toISOString(),
    //     'created': (new Date("2018 March 19")).toISOString(),
         'timeMin': (new Date("2018 May 1")).toISOString(),
         'timeMax': (new Date("2019 March 19")).toISOString(),
         'showDeleted': true,
         'singleEvents': true,
         'maxResults': 10000,
         'orderBy': 'startTime'
      }).then(function(response) {
          
         if(devquit) return;

         google_events = response.result.items;
         var lat = 27.132481;
         var lng = -73.086548;
         appendPre('#### ' + calendars[cal_it].name + ' ####');
         event_it = 0;
         if (google_events.length > 0) {

            treat_event();

         } else {
            appendPre('No upcoming events found for ' + calendars[cal_it].name);
            cal_it++;
            listUpcomingEvents();
         }


      });
   }
        function treat_event() {
      if(devquit) return;
      
      
        if(sourceID =="teamup")
           {
            var teamup_calendar = teamup_calendars[cal_it];
            
             
             if (! teamup_calendar.data[event_it]) 
             {
                 appendPre('Next TeamUp');
                 cal_it++;
                 importTeamUp();
                 return;
             }
            var  event = teamup_calendar.data[event_it];
                
               teamup_calendar.styles = [];
               // TOULOUSE
               if(event.subcalendar_ids.includes(4916134))
                  teamup_calendar.styles.push(dance_styles["blues"])  
               if(event.subcalendar_ids.includes(4916052))
                  teamup_calendar.styles.push(dance_styles["balboa"])  
               if(event.subcalendar_ids.includes(4916051))
                  teamup_calendar.styles.push(dance_styles["lindy"])  
              
               if (teamup_calendar.styles.length==0) teamup_calendar.styles = [dance_styles["lindy"]];
               
               var event_dates = [event.start_dt.substr(0, 10), event.end_dt.substr(0, 10)];
   
               var time_str = "20:00";
               if (! event.all_day )
                time_str =event.start_dt.substr(11, 5) + " - " +event.end_dt.substr(11, 5) ;

               appendPre(event.title + '\n created : ' + event.creation_dt + '\n updated :'+ event.update_dt+ '\n author: '+ teamup_calendar.author );
               var status = "confirmed";
               if (event.delete_dt != null) status = "cancelled";
               geocodeAndSave( teamup_calendar.author, event.title, event.notes, event_dates, time_str, event.location, "cf info", dance_types["parties"], teamup_calendar.styles, status);

              

           }
           if(sourceID =="googleCalendar")
           {
               
               
               if (event_it >= google_events.length) {

                  if (cal_it < calendars.length - 1) {

                     cal_it++;
                     listUpcomingEvents(calendars[cal_it]);
                  } else {
                     appendPre('DONE with import');

                  }
                  return;
               }

               var event = google_events[event_it];
               
            var ref_date_int = 20180531;
            var updated_int = ref_date_int + 1;
            var created_int = ref_date_int + 1
            if(event.updated)
              updated_int = parseInt (event.updated.substr(0, 10).replace(/-/g,'') );
            if(event.created)
               created_int = parseInt (event.created.substr(0, 10).replace(/-/g,'') );
            
            if(updated_int < ref_date_int && created_int < ref_date_int )
            {
                event_it++;
                treat_event();
                return;
            }
            if(calendars[cal_it].author=="moderator")
            {
              if(event.summary.toUpperCase().includes("swing".toUpperCase())     ||   event.description.toUpperCase().includes("swing".toUpperCase())  
               || event.summary.toUpperCase().includes("lindy hop".toUpperCase())    ||   event.description.toUpperCase().includes("lindy hop".toUpperCase())
               || event.summary.toUpperCase().includes("blues".toUpperCase())   ||   event.description.toUpperCase().includes("blues".toUpperCase()) 
               || event.summary.toUpperCase().includes("shag".toUpperCase())   ||   event.description.toUpperCase().includes("shag".toUpperCase()) 
               || event.summary.toUpperCase().includes("balboa".toUpperCase())   ||   event.description.toUpperCase().includes("balboa".toUpperCase()) 
               || event.summary.toUpperCase().includes("charleston".toUpperCase())   ||   event.description.toUpperCase().includes("charleston".toUpperCase()) 
               || event.summary.toUpperCase().includes("electroswing".toUpperCase())   ||   event.description.toUpperCase().includes("electroswing".toUpperCase()) 
               || event.summary.toUpperCase().includes("jazz roots".toUpperCase())   ||   event.description.toUpperCase().includes("jazz roots".toUpperCase()) 
               || event.summary.toUpperCase().includes("bebop".toUpperCase())   ||   event.description.toUpperCase().includes("bebop".toUpperCase())                
               || event.summary.toUpperCase().includes("lindy".toUpperCase())   ||   event.description.toUpperCase().includes("lindy".toUpperCase()) ) 
              {  
                  
              }
              else // not a swingdose event
              {
                event_it++;
                treat_event();
                return; 
              }
            }
            if( event.status !="cancelled")
            appendPre(event.summary + '\n created : ' + event.created + '\n updated :'+ event.updated + '\n author: '+ calendars[cal_it].author );
            
        
            
               if (event === undefined) {
                  appendPre('ERROR event =  ' + event + ' #' + event_it);
                  event_it++;
                  treat_event();
                  return;
               }
               var event_dates = [];
               var when = event.start.dateTime;
               if (!when) {
                  when = event.start.date;
               }
               
             
               var date_str = when.substr(0, 10);
              
               var time_str = when.substr(11, 5);
              
               event_dates.push(date_str);
              
               
                   when = event.end.dateTime;
                   if (!when) {
                      when = event.end.date;
                   }
                   
                   date_str = when.substr(0, 10);
               
                event_dates.push(date_str);

                
               if (event.summary === "" || event.summary === undefined) {
                  appendPre(' Empty title');
                  event_it++;
                  treat_event();
                  return;
               }
               if (date_str === "" || (event.start.dateTime === undefined && event.start.date === undefined)) {
                  appendPre(' Empty :' + date_str + ' / ' + event.start.date + ' for ' + event.summary);
                  event_it++;
                  treat_event();
                  return;
               }
   
               
            
            /*   appendPre( 'EVENT: ' +  author_str+ ' |  ' + event.summary + ' | ' + event.description + ' | ' +
                event_dates.join("..") + ' | ' + time_str + ' | '  + event.location + ' | ' + calendars[cal_it].price + 
               ' | ' + calendars[cal_it].type + ' | ' + calendars[cal_it].styles );*/
               geocodeAndSave(calendars[cal_it].author, event.summary, event.description,  event_dates, time_str, event.location, calendars[cal_it].price, calendars[cal_it].type, calendars[cal_it].styles, event.status);

               // appendPre('Should never be here');
            }
            

      
      
             else if(sourceID =="swingplanit"){
                 var styles = [];
                 var swingplanit_styles = swingplanit_data[event_it].styles.split(',');
                 for(const style of swingplanit_styles )
                 {
                     
                     if(style.toLowerCase().includes("lindy")) styles.push( dance_styles["lindy"]);
                     else if(style.toLowerCase().includes("balboa")) styles.push( dance_styles["balboa"]);
                     else if(style.toLowerCase().includes("blues")) styles.push( dance_styles["blues"]);
                     else if(style.toLowerCase().includes("tap")) styles.push( dance_styles["tap"]);
                     else if(style.toLowerCase().includes("jazz")) styles.push( dance_styles["jazzroots"]);
                     else if(style.toLowerCase().includes("electroswing")) styles.push( dance_styles["electroswing"]);
                     else if(style.toLowerCase().includes("shag")) styles.push( dance_styles["shag"]);
                     else if(style.toLowerCase().includes("charleston")) styles.push( dance_styles["charleston"]);
                     else if(style.toLowerCase().includes("boogie")) styles.push( dance_styles["boogie"]);
                 }
                 
               /* var event_dates_rectified = []; 
             for(const date of swingplanit_data[event_it].dates ) 
              {
                  var d = new Date(date);
                  var rr = d.toLocaleDateString("fr-Fr", {
                      year: "numeric",
                      month: "2-digit",
                      day: "2-digit"
                    }).split('/');
                     event_dates_rectified.push( rr[2] +'-'+rr[1]+'-'+rr[0] ) ;
              }*/
                var event_dates = swingplanit_data[event_it].date_range.split("..");
                 geocodeAndSave( swingplanit_data[event_it].author, swingplanit_data[event_it].title,swingplanit_data[event_it].description, event_dates, "20:00", swingplanit_data[event_it].location, "cf info", dance_types["festivals"], styles, "confirmed" );
             }
    }
            
            
   function geocodeAndSave(event_author, event_title, event_description, event_dates, event_time, event_location, event_price,event_type, event_styles, event_status) {
      
     
      var  event_date_start = event_dates[0];
      //appendPre('Event  #'  + event_title + ' date :' + event_date + ' exists. Skipping..');
      for (var i = 0; i < views_results.length; i++) {
         // console.log('Node  #'  +views_results[i].nid + ':  ' + views_results[i].title);
         // console.log('currentNode.title  '  + event.summary);str = str.replace("'","A");
         /*   if (views_results[i].title.includes("&")  )
           {
               console.log('Node  #'  +views_results[i].nid + ':  ' + views_results[i].title.replace(/&#039;/g,"'").replace(/&amp;/g,"&").replace(/&quot;/g,"\"")+ '');
               
           }*/

         if (views_results[i].title.replace(/&#039;/g, "'").replace(/&amp;/g, "&").replace(/&quot;/g, "\"").trim() == event_title.replace(/&#039;/g, "'").replace(/&amp;/g, "&").replace(/&quot;/g, "\"").trim()) {

             // console.log('Node  #'  +views_results[i].nid + ':  ' + views_results[i].title + ' exists with date : ' +event_date_start+ '. Checking date : ' + views_results[i].field_event_date_range);
             var field_event_date_range= views_results[i].field_event_date_range.split("..");
            if (field_event_date_range[0].search(event_date_start) >= 0) {
                
                if(event_status=="cancelled")
                {
                    locked = true;
                    appendPre('Node  #' + views_results[i].nid + ' :' + event_title + ' date :' + event_date_start + ' exists and has been canceled. Deleting..');
                    jDrupal.nodeLoad(views_results[i].nid).then(function(node) {

                          console.log(i + ') Node #' + views_results[i].nid + ' loaded!');
                    
                          node.delete().then(function() {
                                locked = false;
                                
                                appendPre(i + ') Node #' + views_results[i].nid + ' deleted!');
                                event_it++;
                                treat_event();
                                return;
                             }),
                             function(err) {
                                console.log("node delete error: " + JSON.stringify(err));
                                locked = false;
                             };
                          // then delete it.
                       }, function(err) {
                          console.log("node load error: " + JSON.stringify(err));
                          locked = false;
                     });
                     return;
                }
                else 
                {
                  appendPre('Node  #' + views_results[i].nid + ' :' + event_title + ' date :' + event_date_start + ' exists. Skipping..');
                  
                  event_it++;
                  treat_event();
                  return;
                }
            }
         }
      }
     if(event_status=="cancelled")
     {
           locked = false;
         // appendPre('Event is Cancelled...');
          event_it++;
          treat_event();
          return;
     }
   
        var   lat = 27.132481;
        var   lng = -73.086548;
       locked = true;

         if (event_location == undefined || event_location == null) {
            event_location = "";
         }
         if (event_description == undefined || event_description == null) {
            event_description = "";
         }
         
         geocoder.geocode({
            'address': event_location
         }, function(results, status) {
            if (status === 'OK') {
               lat = results[0].geometry.location.lat();
               lng = results[0].geometry.location.lng();

               // appendPre(' (' + lat +', '  + lng + ')');

            } else {
               // 27.132481 -73.086548
               appendPre('Geocode was not successful for the following reason: ' + status + ' address was: ' + event_location);
               
               
              if(event_author == "hopnswing" )
               {
                    lat =  48.117266;
                    lng = -1.6777925999999752;
                    event_location = "Rennes, France";
               }
               if(event_location.toUpperCase().includes("17 allée Pierre de Coubertin".toUpperCase()) || event_title.toUpperCase().includes("boisset".toUpperCase()) )
               {
                    lat = 48.8180709;
                    lng = 2.3446106;
                    event_location = "17 allée Pierre de Coubertin";
               }
               else if(event_title.toUpperCase().includes("Coolin".toUpperCase() ))
               {
                    lat = 48.8523055;
                    lng = 22.3353461;   
                    event_location = "15, Rue Clément, 75006 Paris";
                    
               }
               else if(event_title.toUpperCase().includes("Machine du Moulin rouge".toUpperCase() ))
               {
                    lat = 48.8841471;
                    lng = 2.3323748999999907;   
                    event_location = "90 Boulevard de Clichy, 75018 Paris";
               } 
               else if(event_title.toUpperCase().includes("Micadanses".toUpperCase() ))
               {
                    lat = 48.8545732;
                    lng = 2.3567477999999937;   
                    event_location = "20 Rue Geoffroy l'Asnier, 75004 Paris";
               }  
               else if(event_title.toUpperCase().includes("Bellevilloise".toUpperCase() ))
               {
                    lat = 48.8683489;
                    lng = 2.3920905999999604;   
                    event_location = "19-21 Rue Boyer, 75020 Paris";
               }
               else if(event_title.toUpperCase().includes("Villette".toUpperCase() ))
               {
                    lat = 48.8938489;
                    lng = 2.390260000000012;   
                    event_location = "211 Avenue Jean Jaurès, 75019 Paris";
               } 
               else if(event_title.toUpperCase().includes("République".toUpperCase() ))
               {
                    lat = 48.8677863;
                    lng = 2.36426670000003;   
                    event_location = "Place de la République, Paris, France";
               }  
               else if(event_title.toUpperCase().includes("Cité U".toUpperCase() ))
               {
                    lat = 48.8200298;
                    lng = 2.338572500000055;   
                    event_location = "17 Boulevard Jourdan, 75014 Paris";
               } 
               else if(event_title.toUpperCase().includes("cabaret Sauvage".toUpperCase() ))
               {
                    lat = 48.8953491;
                    lng = 2.392491899999982;   
                    event_location = "59 Boulevard Macdonald, 75019 Paris";
               }  
               else if(event_title.toUpperCase().includes("cirque électrique ".toUpperCase() ))
               {
                    lat = 48.8766704;
                    lng = 2.4090885000000526;   
                    event_location = "Place du Maquis du Vercors, 75020 Paris";
               }
               else if(event_title.toUpperCase().includes("Machine du Moulin rouge".toUpperCase() ))
               {
                    lat = 48.8841471;
                    lng = 2.3323748999999907;   
                    event_location = "90 Boulevard de Clichy, 75018 Paris";
               } 
               else if(event_title.toUpperCase().includes("FDCA".toUpperCase() ))
               {
                    lat = 48.8292384;
                    lng = 2.325698099999954;   
                    event_location = "5 Rue du Moulin Vert, 75014 Paris, France";
               }  
               else if(event_title.toUpperCase().includes("Comédy Club".toUpperCase() ) || event_title.toUpperCase().includes("Comedy Club".toUpperCase() ) )
               {
                    lat = 48.8708755;
                    lng = 2.348502999999937;   
                    event_location = "42 Boulevard de Bonne Nouvelle, 75010 Paris";
               }
               else if(event_title.toUpperCase().includes("Favela Chic".toUpperCase() ))
               {
                    lat = 48.868343;
                    lng = 2.3662859999999455;   
                    event_location = "18 Rue du Faubourg du Temple, 75011 Paris";
               }   
               else if(event_title.toUpperCase().includes("Regard Du Cygne".toUpperCase() ))
               {
                    lat = 48.8751318;
                    lng = 2.3951256000000285;   
                    event_location = "210 Rue de Belleville, 75020 Paris";
               }                 
               else if(event_title.toUpperCase().includes("Diablito".toUpperCase() ))
               {
                    lat = 48.8618409;
                    lng = 22.371682299999975;   
                    event_location = "45 Rue Saint-Sébastien, 75011 Paris";
               }                 
               else if(event_title.toUpperCase().includes("MK2 Bibliothèque".toUpperCase() ))
               {
                    lat = 48.8326912;
                    lng = 2.3752415000000155;   
                    event_location = "128-162 Avenue de France, 75013 Paris";
               }                 
               else if(event_title.toUpperCase().includes("Frigos".toUpperCase()) || event_location.toUpperCase().includes("3S".toUpperCase() ))
               {
                    lat = 48.8314177;
                    lng = 2.3789881999999807;   
                    event_location = "19 Rue des Frigos, 75013 Paris";
               }                 
               else if(event_title.toUpperCase().includes("Gibus".toUpperCase()) )
               {
                    lat = 48.868343;
                    lng = 2.3662859999999455;   
                    event_location = "18 Rue du Faubourg du Temple, 75011 Paris";
               }                 
               else if(event_title.toUpperCase().includes("quais".toUpperCase()) | event_title.toUpperCase().includes("quai".toUpperCase()) )
               {
                    lat = 48.8473719;
                    lng = 2.361880400000018;   
                    event_location = "2 Quai Saint-Bernard, 75005 Paris";
               }                 
               else if(event_title.toUpperCase().includes("Chalet du Parc".toUpperCase()) || event_title.toUpperCase().includes("SWING ON TUESDAY".toUpperCase()) 
               || event_title.toUpperCase().includes("SWING ON THURSDAY".toUpperCase()))
               {
                    lat = 48.8213684;
                    lng = 2.3346705000000156;   
                    event_location = "28 Boulevard Jourdan, 75014 Paris";
               }                 
               else if(event_title.toUpperCase().includes("chantier".toUpperCase()) || event_title.toUpperCase().includes("Paris Swing Workshop".toUpperCase())  )
               {
                    lat = 48.8543523;
                    lng = 2.4322634000000107;   
                    event_location = "51 Rue Edouard Vaillant, 93100 Montreuil";
               }                 
               else if(event_title.toUpperCase().includes("java".toUpperCase()) )
               {
                    lat = 48.87107880000001;
                    lng = 2.37382869999999;   
                    event_location = "105 Rue du Faubourg du Temple, 75010 Paris";
               } 
               else if(event_title.toUpperCase().includes("PARIS FLYING FESTIVAL".toUpperCase()) )
               {
                    lat = 48.8002289;
                    lng = 2.4030910999999833;   
                    event_location = "13 rue Pierre Sémard, 94400 Vitry-sur-Seine, France";
               }                 
               else if(event_title.toUpperCase().includes("Zingaro".toUpperCase()) || event_title.toUpperCase().includes("Nuit swing".toUpperCase()))
               {
                    lat = 48.91304;
                    lng = 2.40230489999999;   
                    event_location = "176 Av Jean Jaurès, 93300 Aubervilliers";
               }   
               else if(event_title.toUpperCase().includes("Chalet du Lac".toUpperCase()) || event_title.toUpperCase().includes("Châlet du Lac".toUpperCase()))
               {
                    lat = 48.842929;
                    lng = 2.4220880000000307;   
                    event_location = "Orée du Bois de Vincennes, Avenue de Bel Air, 75012 Paris";
               }         
               else if(event_title.toUpperCase().includes("Châtillon".toUpperCase()) || event_title.toUpperCase().includes("Chatillon".toUpperCase()))
               {
                    lat = 48.804689;
                    lng = 2.2893870000000334;   
                    event_location = "92320 Châtillon, France";
               }                 
              else if(event_title.toUpperCase().includes("les Halles".toUpperCase()) || event_title.toUpperCase().includes("des Halles".toUpperCase()))
               {
                    lat = 48.8623348;
                    lng = 2.3447356000000354;   
                    event_location = "Les Halles, 75001 Paris, France";
               }                 
               else if(event_description.toUpperCase().includes("Lechapelais".toUpperCase()) && event_description.toUpperCase().includes("Loft".toUpperCase()))
               {
                    lat = 48.8860959;
                    lng = 2.325608099999954;   
                    event_location = "6 rue Lechapelais, 75017 Paris";
               }       
               else if(event_location.toUpperCase().includes("18 Villa Riverdale 75020 Paris".toUpperCase()))
               {
                    lat = 48.8579124;
                    lng = 2.3969266999999945;   
                    event_location = "18 Villa Riberolle 75020 Paris";
               } 
               else if(event_location.toUpperCase().includes("El Diablito Latino".toUpperCase()))
               {
                    lat = 48.8618673;
                    lng = 2.371718900000019;   
                    event_location = "El Diablito Latino, 45 rue Saint Sébastien, 75011";
               }
               else if(event_location.toUpperCase().includes("El Diablito Latino".toUpperCase()))
               {
                    lat = 48.8660832;
                    lng = 2.3326028999999835;   
                    event_location = "35 Rue Saint-Roch, 75001 Paris, France";
               } 
               
               else if(event_description.toUpperCase().includes("Juste debout".toUpperCase()) || event_title.replace(/&amp;/g, "&").toUpperCase().includes("Hugo & Mélanie".toUpperCase()) 
               || event_description.toUpperCase().includes("hugoandmelanie".toUpperCase())  || event_description.replace(/&amp;/g, "&").toUpperCase().includes("Hugo & Mélanie".toUpperCase())
               || event_title.toUpperCase().includes("Hugo et Mélanie".toUpperCase()) || event_description.toUpperCase().includes("Hugo et Mélanie".toUpperCase())  )
               {
                    lat = 48.8707366;
                    lng = 2.394578700000011;   
                    event_location = "3 Rue de l'Est, 75020 Paris, France";
               }
               else if(event_title.toUpperCase().includes("Carreau du Temple".toUpperCase()) || event_description.toUpperCase().includes("Carreau du Temple".toUpperCase()))
               {
                    lat = 48.8645414;
                    lng = 2.3622311999999965;   
                    event_location = "4 Rue Eugène Spuller, 75003 Paris";
               }
               else if(event_title.toUpperCase().includes("Wonder Follow".toUpperCase()) || event_description.toUpperCase().includes("Wonder Follow ".toUpperCase()))
               {
                    lat = 48.856614;
                    lng = 2.3522219000000177;   
                    event_location = "Paris";
               }
               else if(event_title.toUpperCase().includes("Strandbad Weiseensee".toUpperCase()) || event_description.toUpperCase().includes("Strandbad Weiseensee".toUpperCase()))
               {
                    lat = 52.5539678;
                    lng = 13.46;   
                    event_location = "Strandbad Weiseensee";
               }  
               else if(event_title.toUpperCase().includes("Balto".toUpperCase()) || event_description.toUpperCase().includes("Balto".toUpperCase()))
               {
                    lat = 48.8558711;
                    lng = 2.423;   
                    event_location = "Le Balto Bar, Montreuil";
               }  
               else if(calendars[cal_it].name =="Swing y Blues en Buenos Aires" && calendars[cal_it].name !="Lindy Hop Paris - Ailleurs en France" )
               {
                  lat = -34.6036844;
                  lng = -58.3815591;
                  event_location = "Buenos Aires, Argentina";
               }
               else if(calendars[cal_it].name =="Lindy Hop Paris - Ailleurs en France" )
               {
                  lat = 46.227638;
                  lng = 2.213749;
                  event_location = "France";
               }               
               else 
               { 
                     lat = 27.132481;
                     lng = -73.086548;
                  //  lat = 48.856614;
                //    lng = 2.3522219000000177;   
                    event_location = "";                     
                   //  event_location = "Bermuda Triangle";
               }
                prev_address = event_location;
               
              
            }
             
            
            
             if(sourceID !="swingplanit"){
                 
             if(event_title.toUpperCase().includes("Pratique".toUpperCase())     ||   event_description.toUpperCase().includes("Pratique".toUpperCase())  
               || event_title.toUpperCase().includes("practice".toUpperCase())    ||   event_description.toUpperCase().includes("practice".toUpperCase())
               || event_title.toUpperCase().includes("practica".toUpperCase())   ||   event_description.toUpperCase().includes("practica".toUpperCase()) 
               || event_title.toUpperCase().includes("práctica".toUpperCase())   ||   event_description.toUpperCase().includes("práctica".toUpperCase()) 
               || event_title.toUpperCase().includes("Entrainement".toUpperCase())   ||   event_description.toUpperCase().includes("Entrainement".toUpperCase()) ) 
              {
                  event_type = dance_types["practices"];
              }
              else
              if(event_title.toUpperCase().includes("Festival".toUpperCase())     ||   event_description.toUpperCase().includes("Festival".toUpperCase())  
               || event_title.toUpperCase().includes("Fest".toUpperCase())    ||   event_description.toUpperCase().includes("Fest".toUpperCase()) )
               //|| event_title.toUpperCase().includes("practica".toUpperCase())   ||   event_description.toUpperCase().includes("practica".toUpperCase()) ) 
              {
                  event_type = dance_types["festivals"];
              }
              else
              if(event_title.toUpperCase().includes("Stage".toUpperCase())     ||   event_description.toUpperCase().includes("Stage".toUpperCase())  
               || event_title.toUpperCase().includes("Workshop".toUpperCase())    ||   event_description.toUpperCase().includes("Workshop".toUpperCase())
               || event_title.toUpperCase().includes("Taller".toUpperCase())   ||   event_description.toUpperCase().includes("Taller".toUpperCase()) 
               || event_title.toUpperCase().includes("Cours".toUpperCase())   ||   event_description.toUpperCase().includes("Cours".toUpperCase()) 
               || event_title.toUpperCase().includes("Atelier".toUpperCase())   ||   event_description.toUpperCase().includes("Atelier".toUpperCase()) )
              {
                  event_type = dance_types["workshops"];
              } 
              else
              if(event_title.toUpperCase().includes("Soirée".toUpperCase())     ||   event_description.toUpperCase().includes("Soirée".toUpperCase())  
               || event_title.toUpperCase().includes("Bal".toUpperCase())    ||   event_description.toUpperCase().includes("Bal".toUpperCase())
               || event_title.toUpperCase().includes("Party".toUpperCase())   ||   event_description.toUpperCase().includes("Party".toUpperCase())  
               || event_title.toUpperCase().includes("Nuit".toUpperCase())   ||   event_description.toUpperCase().includes("Nuit".toUpperCase()) )               
              {
                  event_type = dance_types["parties"];
              }
              else
              if(event_title.toUpperCase().includes("République".toUpperCase())     ||   event_description.toUpperCase().includes("République".toUpperCase())  
               || event_title.toUpperCase().includes("Open air".toUpperCase())    ||   event_description.toUpperCase().includes("Open air".toUpperCase())
               || event_title.toUpperCase().includes("Plein air".toUpperCase())   ||   event_description.toUpperCase().includes("Plein air".toUpperCase()) 
               || event_title.toUpperCase().includes("Outdoor".toUpperCase())    ||   event_description.toUpperCase().includes("Outdoor".toUpperCase())
               || event_author == "dancingoutsideparis"
               //|| event_title.toUpperCase().includes("Nuit".toUpperCase())   ||   event_description.toUpperCase().includes("Nuit".toUpperCase()) 
               )               
              {
                  event_type = dance_types["openair"];
              } 
              else
              if(event_title.toUpperCase().includes("Blues".toUpperCase())     ||   event_description.toUpperCase().includes("Blues".toUpperCase())  
               || event_title.toUpperCase().includes("Блюз".toUpperCase())    ||   event_description.toUpperCase().includes("Блюз".toUpperCase()) )
              {
                  event_styles = [dance_styles["blues"]];
              }
              if(event_title.toUpperCase().includes("Lindy".toUpperCase())     ||   event_description.toUpperCase().includes("Lindy".toUpperCase())  
               || event_title.toUpperCase().includes("Линди".toUpperCase())    ||   event_description.toUpperCase().includes("Линди".toUpperCase()) )
              {
                  event_styles = [dance_styles["lindy"]];
              }   
              if(event_title.toUpperCase().includes("Shag".toUpperCase())     ||   event_description.toUpperCase().includes("Shag".toUpperCase())  
               || event_title.toUpperCase().includes("Шэг".toUpperCase())    ||   event_description.toUpperCase().includes("Шэг".toUpperCase()) )
              {
                  event_styles = [dance_styles["shag"]];
              }              
              else
              if(event_title.toUpperCase().includes("Annulé".toUpperCase())     ||   event_description.toUpperCase().includes("Annulé".toUpperCase())  
               || event_title.toUpperCase().includes("Canceled".toUpperCase())    ||   event_description.toUpperCase().includes("Canceled".toUpperCase())
               /*|| event_title.toUpperCase().includes("Party".toUpperCase())   ||   event_description.toUpperCase().includes("Party".toUpperCase())  
               || event_title.toUpperCase().includes("Nuit".toUpperCase())   ||   event_description.toUpperCase().includes("Nuit".toUpperCase()) */)               
              {
                  event_type = dance_types["canceled"];
              }
             }
              
              if("OVER_QUERY_LIMIT" == status )
               {
                   delay_init+=300;
                   locked = false;
                   appendPre('Retry...')
                   treat_event();
                   return;
               }
               else 
               {
                  delay_init = 10;  
                  event_description += '<br> <a href="http://maps.google.com/?q=' + event_location + '">' + event_location + '</a>';
                  
            if (event_type < 10000) {

               appendPre('Node  ' + event_title + ' date :' + event_date_start + ' wrong event type : ' + event_type);
               event_it++;
               treat_event();
               return;
            }   
            
                 // for(const user of users)
                 event_author = event_author.replace(/\s/g, '');
                  if(event_author.length>16)  
                      {
                        //  event_author_old = event_author;
                          event_author=event_author.split("_")[0];
                      }
                   var index = users.map(function(e) { return e.name; }).indexOf(event_author);
                   
                   if(index<0)
                   {
                      
                     var newUser= new jDrupal.User({
	                		// type: [ { value: 'user' } ],
	                		name: [ { value: event_author }],
	                		mail: [ { value: event_author + "@dancedose.com" }],   //( username + "@dancedose.com" )
	                		pass: [ { value: "48.85,2.35" }],
	                	    roles:[ { target_id: "organiser"} ],  //authenticated
	                		preferred_langcode:[ {value: "en"}],
	                		field_user_styles: [ { target_id: "1" }],
	                		status:[{value: true}]
	                	});
		            	newUser.save().then(function() {
		            	    users.push({
                                name : event_author,
                               uid : newUser.id()
                              });
		            	    console.log("Created user id: " +  newUser.id() +" name: "+ event_author);
		            	    saveNode(lat, lng, newUser.id());
		            	    
                             return;
		            	}, function(err){
		            	      console.log("Error user "+ event_author);
		            		 appendPre("saving error: " + JSON.stringify(err));
		            		 return;
		            	});	                	
                   }
                   else{
                  
                    saveNode(lat, lng, users[index].uid);
                    return;
                   }
                  
               }



         }); // .geocode


      function saveNode(lat, lng, uid) {
         
         
       
           
         if(lat == 27.132481 ){
             appendPre("Localizing problem. Event: " + event_title +" ("+event_description+") at: " +event_location);
           //  devquit = true;
            // return;
         } 

                var event_styles_formatted = []; 
               for (it in event_styles) {
                 event_styles_formatted.push({
                   target_id: event_styles[it]
                 });
               }
               
               if(event_type == dance_types["parties"] || event_type == dance_types["practices"])
               {
                   event_dates[1] = event_dates[0];
               }
                   

               var event_date_range =[ {
                   value: event_dates[0],
                   end_value: event_dates[1]
                 }];

         
         (function($) {
            var currentNode = new $.Node({
               type: [{
                  target_id: 'event'
               }],
               title: [{
                  value: event_title
               }],
               field_event_address: [{
                  lat: lat,
                  lng: lng
               }],
               field_event_description: [{
                  value: event_description
               }],
               field_event_date_range:
                     event_date_range,
               field_event_price: [{
                  value: event_price
               }],
               field_event_time: [{
                  value: event_time
               }],
               field_event_type: [{
                  target_id: event_type
               }],
               field_event_venue: [{
                  value: event_location
               }],
               uid: [{
                  target_id: uid
               }],
               field_event_styles: event_styles_formatted
            });
            console.log(currentNode);
            currentNode.save().then(function() {
                  // nodeLoad();
                  ///	currentNode.postSave().then(function() {
                  appendPre(global_it + "): Saved node #" + currentNode.id() + ' ' + JSON.stringify(currentNode));
                  global_it++;
                  locked = false;
                  //	});
               },
               function(err) {
                  appendPre("saving error: " + JSON.stringify(err));
                  locked = false;
                  // appendPre(  "Error: " + JSON.stringify(currentNode) )                 	});  
               });
               
         }(jDrupal));
         
            delay = delay_init;
            timerId = setTimeout(function() {
               delay = 10;
               timerId = setTimeout(eventTimer, delay);
            }, delay);


      } //saveNode(lat, ln    

   } // function geocodeSAve
   
   var delay_cnt=0;
   
   function eventTimer() {
               if (devquit) return;
               if (!locked) {
                 // appendPre('UNLOCKED for event_it = ' + event_it + ' cal_it=' + cal_it);   
                 appendPre("Spent " + (delay_cnt +delay_init) +"ms");
                 delay_cnt = 0;
                // delay_init+=10;
                  event_it++;
                  treat_event();
                  return;
               } else {
                  timerId = setTimeout(eventTimer, delay);
                  delay_cnt +=delay;

                   //appendPre('LOCKED for event_it = ' + event_it + ' cal_it=' + cal_it);
                  return;
               }

            }
            
            
            
      // Creates a CORS request in a cross-browser manner
    function createCORSRequest(method, url) {
        var apiKey = TEAMUP_API_KEY;
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
            // XHR for Chrome/Firefox/Opera/Safari/IE10+.
            xhr.open(method, url, true);
            xhr.setRequestHeader('Teamup-Token', apiKey);
        } else if (typeof XDomainRequest != "undefined") {
            // XDomainRequest for IE8/IE9.
            xhr = new XDomainRequest();
            // XDomainRequest does not support querying HTTPS from HTTP pages
            if (window.location.protocol === 'http:') {
                url = url.replace('https://', 'http://');
            }
            if (-1 === ['GET', 'POST'].indexOf(method)) {
                alert('XDomainRequest only supports GET and POST methods');
                return;
            }
            if (-1 === url.indexOf('?')) {
                url += '?_teamup_token=' + apiKey;
            } else {
                url += '&_teamup_token=' + apiKey;
            }
            xhr.open(method, url);
        } else {
            // CORS not supported.
            xhr = null;
        }
        return xhr;
    }
    
    // Sends the actual CORS request.
    function makeCorsRequest(url, successCallback, errorCallback) {
        var xhr = createCORSRequest('GET', url);
        if (!xhr) {
            alert('CORS not supported');
            return;
        }
    
        // Response handlers.
        xhr.onload = function (xhr) {
            if (xhr.target.status < 400) {
                if (successCallback) successCallback(xhr.target);
            } else if (errorCallback) {
                errorCallback(xhr.target);
            }
        };
        xhr.onerror = function (xhr) {
            if (errorCallback) {
                errorCallback(xhr.target);
            }
        };
    
        xhr.send();
    }
    
  
            
            
            
            
            
   </script>

   <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
   </script>
</body>

</html>